name: Auto-merge

on:
  workflow_run:
    workflows: [E2E testing for EC-CUBE]
    types: [completed]

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success'
    permissions:
      pull-requests: write
      contents: write
    env:
      PR_URL: ${{github.event.pull_request.html_url}}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository with preceding commits
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"
      - name: Dump steps context
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump runner context
        env:
          RUNNER_CONTEXT: ${{ toJson(runner) }}
        run: echo "$RUNNER_CONTEXT"
      - name: Dump strategy context
        env:
          STRATEGY_CONTEXT: ${{ toJson(strategy) }}
        run: echo "$STRATEGY_CONTEXT"
      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJson(matrix) }}
        run: echo "$MATRIX_CONTEXT"
      - name: Approve PR
        run: gh pr review "$PR_URL" --approve
      ## いきなりマージするのが怖いので、一旦自動承認（↑）だけにする
      #- name: Enable auto-merge
      #  run: gh pr merge --merge --auto "$PR_URL"

  failed:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: failed
        env:
          WORKFLOW_RUN_CONTEXT: ${{ toJson(github.event.workflow_run) }}
        # 失敗したときにデバッグ用に情報を出力しておく
        run: |
          echo "Haven't met the conditions to merge yet"
          echo "$WORKFLOW_RUN_CONTEXT"
          exit 1
